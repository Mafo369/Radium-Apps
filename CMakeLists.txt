macro(SUBDIRLIST result curdir)
  file(GLOB children RELATIVE ${curdir} ${curdir}/*)
  set(dirlist "")
  foreach(child ${children})
    if(IS_DIRECTORY ${curdir}/${child})
        list(APPEND dirlist ${child})
    endif()
  endforeach()
  set(${result} ${dirlist})
endmacro()

SUBDIRLIST(SUBDIRS ${CMAKE_CURRENT_SOURCE_DIR})
message("The following plugins will be compiled : ${SUBDIRS}")

# setup to create the Systems.cpp file where all systems are registered.
set (system_string "#include<MainApplication/MainApplication.hpp>\n\n")
set (header_string "/* This file is automatically generated     * \n * from the contents of the Plugins/ folder * \n * see Plugins/CMakeLists.txt for details   */\n\n")
set (register_string "void Ra::MainApplication::registerSystems() {\n")

foreach(subdir ${SUBDIRS})
    add_subdirectory( ${subdir} )
    
    set( header_string
         "${header_string}#include <Plugins/${subdir}/${subdir}System.hpp>\n")

    set( register_string
         "${register_string}    RA_REGISTER_SYSTEM_PLUGIN(${subdir})\n" )

endforeach()

set( header_string "${header_string}\n" )
set( register_string "${register_string}}" )

set( sys_dir ${CMAKE_SOURCE_DIR}/src/MainApplication )
set( sys_file ${sys_dir}/Systems.cpp )
file(WRITE ${sys_file} ${system_string})
file(APPEND ${sys_file} ${header_string})
file(APPEND ${sys_file} ${register_string})

configure_file( ${sys_file} ${sys_dir} )

set(plugins ${SUBDIRS})
